name: Test Dotfiles

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  syntax-validation:
    name: Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck lua5.4 zsh

          # Install taplo for TOML validation
          curl -fsSL https://github.com/tamasfe/taplo/releases/latest/download/taplo-linux-x86_64.gz | gunzip -c | sudo tee /usr/local/bin/taplo > /dev/null
          sudo chmod +x /usr/local/bin/taplo

      - name: Run syntax validation
        run: ./test.sh

  test-macos:
    name: Test on macOS
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run setup script
        run: |
          # Run setup script in non-interactive mode
          ./setup.sh
        env:
          CI: true

      - name: Debug stow results
        run: |
          echo "Checking what was stowed..."
          ls -la ~/ | grep -E "^\.|zshrc|gitconfig|tmux.conf" || echo "No dotfiles found in home"
          echo "---"
          echo "Checking if symlinks exist:"
          ls -la ~/.zshrc || echo "~/.zshrc does not exist"
          ls -la ~/.gitconfig || echo "~/.gitconfig does not exist"
          ls -la ~/.tmux.conf || echo "~/.tmux.conf does not exist"

      - name: Verify zsh configuration loads
        run: |
          # Source Homebrew environment first
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          zsh -c "source ~/.zshrc && echo 'zsh config loaded successfully'"

      - name: Verify tmux configuration loads
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          if command -v tmux >/dev/null 2>&1; then
            tmux -f ~/.tmux.conf list-keys >/dev/null 2>&1 || echo "tmux config check skipped (plugins may not be installed)"
          fi

      - name: Verify neovim configuration
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          if command -v nvim >/dev/null 2>&1; then
            nvim --headless -c "checkhealth" -c "quit" 2>&1 | head -20 || echo "nvim check completed"
          fi

      - name: Verify git configuration
        run: |
          if [ -L ~/.gitconfig ]; then
            echo "✓ .gitconfig symlinked"
          else
            echo "✗ .gitconfig is not a symlink"
            ls -la ~/.gitconfig || echo "✗ .gitconfig does not exist"
            exit 1
          fi
          if git config --list | grep -q "alias.addf"; then
            echo "✓ git aliases loaded"
          else
            echo "✗ git aliases not found"
            exit 1
          fi

      - name: List installed tools
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          echo "Installed tools:"
          for cmd in zsh tmux nvim git stow fzf rg; do
            if command -v $cmd >/dev/null 2>&1; then
              echo "✓ $cmd: $($cmd --version 2>&1 | head -1)"
            else
              echo "✗ $cmd: not installed"
            fi
          done

  test-ubuntu:
    name: Test on Ubuntu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run setup script
        run: |
          # Run setup script in non-interactive mode
          ./setup.sh
        env:
          CI: true

      - name: Debug stow results
        run: |
          echo "Checking what was stowed..."
          ls -la ~/ | grep -E "^\.|zshrc|gitconfig|tmux.conf" || echo "No dotfiles found in home"
          echo "---"
          echo "Checking if symlinks exist:"
          ls -la ~/.zshrc || echo "~/.zshrc does not exist"
          ls -la ~/.gitconfig || echo "~/.gitconfig does not exist"
          ls -la ~/.tmux.conf || echo "~/.tmux.conf does not exist"

      - name: Verify zsh configuration loads
        run: |
          # Source Homebrew environment first
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          zsh -c "source ~/.zshrc && echo 'zsh config loaded successfully'"

      - name: Verify tmux configuration loads
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          if command -v tmux >/dev/null 2>&1; then
            tmux -f ~/.tmux.conf list-keys >/dev/null 2>&1 || echo "tmux config check skipped (plugins may not be installed)"
          fi

      - name: Verify neovim configuration
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          if command -v nvim >/dev/null 2>&1; then
            nvim --headless -c "checkhealth" -c "quit" 2>&1 | head -20 || echo "nvim check completed"
          fi

      - name: Verify git configuration
        run: |
          if [ -L ~/.gitconfig ]; then
            echo "✓ .gitconfig symlinked"
          else
            echo "✗ .gitconfig is not a symlink"
            ls -la ~/.gitconfig || echo "✗ .gitconfig does not exist"
            exit 1
          fi
          if git config --list | grep -q "alias.addf"; then
            echo "✓ git aliases loaded"
          else
            echo "✗ git aliases not found"
            exit 1
          fi

      - name: List installed tools
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "Installed tools:"
          for cmd in zsh tmux nvim git stow fzf rg; do
            if command -v $cmd >/dev/null 2>&1; then
              echo "✓ $cmd: $($cmd --version 2>&1 | head -1)"
            else
              echo "✗ $cmd: not installed"
            fi
          done

  test-windows:
    name: Test on Windows
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Windows setup script
        shell: pwsh
        run: |
          # Run setup script (skip symlinks in CI as they require admin)
          .\setup-windows.ps1 -SkipSymlinks
        env:
          CI: true

      - name: Verify tools installed
        shell: pwsh
        run: |
          Write-Host "Checking installed tools..."
          
          $tools = @(
            @{ Name = "git"; Cmd = "git --version" },
            @{ Name = "nvim"; Cmd = "nvim --version" },
            @{ Name = "fzf"; Cmd = "fzf --version" },
            @{ Name = "rg"; Cmd = "rg --version" },
            @{ Name = "zoxide"; Cmd = "zoxide --version" },
            @{ Name = "lazygit"; Cmd = "lazygit --version" },
            @{ Name = "node"; Cmd = "node --version" },
            @{ Name = "python"; Cmd = "python --version" },
            @{ Name = "bun"; Cmd = "bun --version" }
          )
          
          $failed = $false
          foreach ($tool in $tools) {
            # Refresh PATH to pick up newly installed tools
            $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
            
            try {
              $output = Invoke-Expression $tool.Cmd 2>&1 | Select-Object -First 1
              Write-Host "[OK] $($tool.Name): $output" -ForegroundColor Green
            }
            catch {
              Write-Host "[X] $($tool.Name): not found or failed" -ForegroundColor Red
              $failed = $true
            }
          }
          
          if ($failed) {
            Write-Host "`nSome tools failed to install, but continuing..." -ForegroundColor Yellow
          }

      - name: Test symlink creation
        shell: pwsh
        run: |
          Write-Host "Testing symlink creation for configs..."
          
          $dotfilesDir = $PWD.Path
          $homeDir = $env:USERPROFILE
          $appDataLocal = $env:LOCALAPPDATA
          
          # Test git config symlink
          $gitSource = Join-Path $dotfilesDir "git\.gitconfig"
          $gitTarget = Join-Path $homeDir ".gitconfig"
          
          if (Test-Path $gitSource) {
            try {
              New-Item -ItemType SymbolicLink -Path $gitTarget -Target $gitSource -Force | Out-Null
              Write-Host "[OK] Git config symlink created" -ForegroundColor Green
              
              # Verify git can read the config
              $aliases = git config --list | Select-String "alias"
              if ($aliases) {
                Write-Host "[OK] Git aliases loaded from config" -ForegroundColor Green
              }
            }
            catch {
              Write-Host "[!] Could not create symlink (expected in CI without admin)" -ForegroundColor Yellow
              # Fall back to copy
              Copy-Item -Path $gitSource -Destination $gitTarget -Force
              Write-Host "[OK] Git config copied instead" -ForegroundColor Green
            }
          }
          
          # Test neovim config symlink
          $nvimSource = Join-Path $dotfilesDir "nvim\.config\nvim"
          $nvimTarget = Join-Path $appDataLocal "nvim"
          
          if (Test-Path $nvimSource) {
            try {
              New-Item -ItemType SymbolicLink -Path $nvimTarget -Target $nvimSource -Force | Out-Null
              Write-Host "[OK] Neovim config symlink created" -ForegroundColor Green
            }
            catch {
              Write-Host "[!] Could not create symlink (expected in CI without admin)" -ForegroundColor Yellow
              Copy-Item -Path $nvimSource -Destination $nvimTarget -Recurse -Force
              Write-Host "[OK] Neovim config copied instead" -ForegroundColor Green
            }
          }

      - name: Validate WezTerm Windows config syntax
        shell: pwsh
        run: |
          Write-Host "Validating WezTerm Windows config..."
          $weztermConfig = "wezterm\.wezterm-windows.lua"
          
          if (Test-Path $weztermConfig) {
            # Basic Lua syntax check using PowerShell pattern matching
            $content = Get-Content $weztermConfig -Raw
            
            # Check for common Lua syntax issues
            if ($content -match "return config") {
              Write-Host "[OK] WezTerm Windows config has valid structure" -ForegroundColor Green
            }
            else {
              Write-Host "[X] WezTerm config missing 'return config'" -ForegroundColor Red
              exit 1
            }
          }
          else {
            Write-Host "[X] WezTerm Windows config not found" -ForegroundColor Red
            exit 1
          }

      - name: Validate PowerShell setup script syntax
        shell: pwsh
        run: |
          Write-Host "Validating PowerShell script syntax..."
          
          $scriptPath = "setup-windows.ps1"
          $errors = $null
          
          $ast = [System.Management.Automation.Language.Parser]::ParseFile(
            $scriptPath,
            [ref]$null,
            [ref]$errors
          )
          
          if ($errors.Count -eq 0) {
            Write-Host "[OK] setup-windows.ps1 has valid syntax" -ForegroundColor Green
          }
          else {
            Write-Host "[X] Syntax errors found:" -ForegroundColor Red
            $errors | ForEach-Object { Write-Host "  - $_" }
            exit 1
          }

  test-stow:
    name: Test Stow Symlinks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stow
        run: sudo apt-get update && sudo apt-get install -y stow

      - name: Test stow dry-run
        run: |
          echo "Testing stow operations (dry-run)..."
          stow -n -v -t ~ zsh git tmux 2>&1 | tee stow-output.log

          # Check for conflicts
          if grep -i "conflict" stow-output.log; then
            echo "⚠️ Stow conflicts detected"
            exit 1
          else
            echo "✓ No stow conflicts detected"
          fi

      - name: Test actual stow
        run: |
          # Actually create symlinks
          stow -v -t ~ zsh git tmux

          # Verify symlinks were created
          [ -L ~/.zshrc ] && echo "✓ .zshrc symlinked"
          [ -L ~/.gitconfig ] && echo "✓ .gitconfig symlinked"
          [ -L ~/.tmux.conf ] && echo "✓ .tmux.conf symlinked"
